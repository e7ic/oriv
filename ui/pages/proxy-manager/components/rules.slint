import { VerticalBox, HorizontalBox, ScrollView } from "std-widgets.slint";
import { GlobeIcon, TrashIcon, PlusIcon } from "@lucide";
import {
    ToggleSwitch,
    Button,
    Tag,
    Input,
    Select,
} from "../../../components/index.slint";

export struct ProxyRule {
    id: string,
    domain: string,
    target: string,
    protocol: string,
    enabled: bool,
}

component RuleItem inherits Rectangle {
    in property <string> domain;
    in property <string> target;
    in property <string> protocol;
    in property <bool> enabled;
    callback toggle(bool);
    callback edit();
    callback delete();
    height: 72px;
    background: white;
    border-radius: 8px;
    border-width: 1px;
    border-color: #e5e7eb;
    HorizontalLayout {
        padding-left: 24px;
        padding-right: 24px;
        alignment: space-between;
        HorizontalLayout {
            spacing: 16px;
            alignment: start;
            
            // Icon: Globe
            Rectangle {
                width: 40px;
                height: 40px;
                y: (parent.height - self.height) / 2;
                GlobeIcon {
                    width: 24px;
                    height: 24px;
                    colorize: #3b82f6;
                    x: (parent.width - self.width) / 2;
                    y: (parent.height - self.height) / 2;
                }
            }

            VerticalLayout {
                alignment: center;
                spacing: 4px;
                HorizontalLayout {
                    spacing: 8px;
                    Text {
                        text: root.domain;
                        font-size: 14px;
                        font-weight: 500;
                        color: #111827;
                    }
                    
                    // Protocol Badge
                    Tag {
                        text: root.protocol;
                        y: (parent.height - self.height) / 2;
                    }
                }

                HorizontalLayout {
                    spacing: 8px;
                    Text {
                        text: "→";
                        color: #9ca3af;
                        font-size: 12px;
                    }

                    Text {
                        text: root.target;
                        font-size: 13px;
                        color: #6b7280;
                    }
                }
            }
        }

        HorizontalLayout {
            spacing: 16px;
            alignment: end;

            Button {
                text: "编辑";
                outline: true;
                clicked => {
                    root.edit();
                }
                y: (parent.height - self.height) / 2;
            }
            
            // Status Toggle
            Button {
                danger: true;
                clicked => {
                    root.delete();
                }
                y: (parent.height - self.height) / 2;
                TrashIcon {
                    width: 16px;
                    height: 16px;
                    colorize: white;
                    y: (parent.height - self.height) / 2;
                }
            }
        }
    }
}

export component ProxyRules inherits VerticalLayout {
    spacing: 24px;
    padding-bottom: 24px;
    alignment: start;
    in property <[ProxyRule]> rules;
    callback add-rule(string, string, string); // domain, target, protocol
    callback update-rule(string, string, string, string); // id, domain, target, protocol
    callback remove-rule(string); // id
    callback validate-target-port(string) -> bool;

    // Local properties for inputs (Slint 1.15: struct field two-way bindings)
    in-out property <ProxyRule> draft-rule: {
        id: "",
        domain: "",
        target: "",
        protocol: "HTTP",
        enabled: true,
    };
    in-out property <string> editing-rule-id: "";
    in-out property <string> validation-error: "";

    // Add Rule Section
    Rectangle {
        background: white;
        border-radius: 12px;
        border-width: 1px;
        border-color: #e5e7eb;
        VerticalLayout {
            padding: 24px;
            spacing: 24px;
            VerticalLayout {
                spacing: 8px;
                Text {
                    text: "添加代理规则";
                    font-size: 16px;
                    font-weight: 600;
                    color: #111827;
                }

                Text {
                    text: "将自定义域名映射到本地端口";
                    color: #6b7280;
                    font-size: 14px;
                }

                if root.editing-rule-id != "": Text {
                    text: "正在编辑规则";
                    color: #b45309;
                    font-size: 13px;
                }
            }

            HorizontalLayout {
                spacing: 16px;
                height: 64px; // Container height for inputs

                // Domain Input
                VerticalLayout {
                    spacing: 8px;
                    Text {
                        text: "自定义域名";
                        font-size: 13px;
                        font-weight: 500;
                        color: #374151;
                    }

                    Input {
                        placeholder: "local.example.com";
                        text <=> root.draft-rule.domain;
                    }
                }

                // Port Input
                VerticalLayout {
                    spacing: 8px;
                    width: 120px;
                    Text {
                        text: "目标端口";
                        font-size: 13px;
                        font-weight: 500;
                        color: #374151;
                    }

                    Input {
                        placeholder: "3000";
                        text <=> root.draft-rule.target;
                        edited(text) => {
                            if text == "" {
                                root.validation-error = "";
                            } else if !root.validate-target-port(text) {
                                root.validation-error = "目标端口必须是 1-65535 的数字";
                            } else {
                                root.validation-error = "";
                            }
                        }
                    }
                }

                // Protocol Select
                VerticalLayout {
                    spacing: 8px;
                    width: 120px;
                    Text {
                        text: "协议";
                        font-size: 13px;
                        font-weight: 500;
                        color: #374151;
                    }

                    Select {
                        value <=> root.draft-rule.protocol;
                        options: ["HTTP", "HTTPS"];
                        selected(val) => {
                            root.draft-rule.protocol = val;
                        }
                    }
                }
            }

            if root.validation-error != "": Text {
                text: root.validation-error;
                color: #dc2626;
                font-size: 13px;
            }

            // Save/Add Buttons
            HorizontalLayout {
                spacing: 12px;

                Button {
                    text: root.editing-rule-id == "" ? "添加规则" : "保存修改";
                    height: 40px;
                    clicked => {
                        if (root.draft-rule.domain != "" && root.draft-rule.target != "") {
                            if !root.validate-target-port(root.draft-rule.target) {
                                root.validation-error = "目标端口必须是 1-65535 的数字";
                                return;
                            }

                            if root.editing-rule-id == "" {
                                root.add-rule(root.draft-rule.domain, root.draft-rule.target, root.draft-rule.protocol);
                            } else {
                                root.update-rule(root.editing-rule-id, root.draft-rule.domain, root.draft-rule.target, root.draft-rule.protocol);
                            }
                            root.validation-error = "";
                            root.editing-rule-id = "";
                            root.draft-rule.domain = "";
                            root.draft-rule.target = "";
                            root.draft-rule.protocol = "HTTP";
                        }
                    }
                    PlusIcon {
                        width: 16px;
                        height: 16px;
                        colorize: white;
                        y: (parent.height - self.height) / 2;
                    }
                }

                if root.editing-rule-id != "": Button {
                    text: "取消编辑";
                    outline: true;
                    height: 40px;
                    clicked => {
                        root.validation-error = "";
                        root.editing-rule-id = "";
                        root.draft-rule.domain = "";
                        root.draft-rule.target = "";
                        root.draft-rule.protocol = "HTTP";
                    }
                }
            }
        }
    }

    // Active Rules List
    Rectangle {
        background: white;
        border-radius: 12px;
        border-width: 1px;
        border-color: #e5e7eb;
        VerticalLayout {
            padding: 24px;
            spacing: 16px;
            VerticalLayout {
                spacing: 8px;
                Text {
                    text: "活动代理规则";
                    font-size: 16px;
                    font-weight: 600;
                    color: #111827;
                }

                Text {
                    text: "已配置 " + root.rules.length + " 条规则";
                    color: #6b7280;
                    font-size: 14px;
                }
            }

            VerticalLayout {
                spacing: 12px;
                for rule in root.rules: RuleItem {
                    domain: rule.domain;
                    target: rule.target;
                    protocol: rule.protocol;
                    enabled: rule.enabled;
                    edit => {
                        root.validation-error = "";
                        root.editing-rule-id = rule.id;
                        root.draft-rule.domain = rule.domain;
                        root.draft-rule.target = rule.target;
                        root.draft-rule.protocol = rule.protocol;
                    }
                    delete => {
                        root.remove-rule(rule.id);
                    }
                }
            }
        }
    }
}
