import { Button, VerticalBox, HorizontalBox } from "std-widgets.slint";
import { Sidebar, TitleBar } from "./components/index.slint";
import { ProxyManager } from "./pages/proxy-manager/page.slint";
import { ProxyRule } from "./pages/proxy-manager/components/rules.slint";
import { CertInfo } from "./pages/proxy-manager/components/certificates.slint";
import { LogEntry } from "./pages/proxy-manager/components/logs.slint";

export component AppWindow inherits Window {
    icon: @image-url("../assets/app-icon.png");
    title: "";
    preferred-width: 1200px;
    preferred-height: 800px;
    min-width: 800px;
    min-height: 600px;
    no-frame: true;  // 移除系统标题栏和边框
    background: transparent;
    default-font-family: "Kamerik 105";

    in-out property <int> counter: 42;
    callback request-increase-value();

    // 窗口控制回调
    callback minimize-window();
    callback maximize-window() -> bool;  // 返回是否最大化
    callback close-window();
    callback start-drag-window();  // 开始拖动窗口
    callback start-resize-window(int);  // 开始调整窗口大小，参数：方向(0-7)

    // 窗口状态
    in-out property <bool> is-maximized: false;

    // 平台检测
    in-out property <bool> is-macos: false;  // 由 Rust 代码设置

    // 主题相关
    in-out property <bool> dark-mode: false;
    callback toggle-theme();

    // 颜色定义
    property <color> bg-color: dark-mode ? #1f2937 : #f3f4f6;
    property <color> titlebar-bg: dark-mode ? #111827 : #ffffff;
    property <color> text-color: dark-mode ? #f3f4f6 : #111827;
    property <color> icon-color: dark-mode ? #9ca3af : #4b5563;
    property <color> button-hover-bg: dark-mode ? #374151 : #e5e7eb;

    // 窗口调整大小相关
    property <length> resize-border-size: 8px;  // 可拖动边缘的宽度

    // 代理控制
    callback toggle-proxy(bool);
    in property <bool> proxy-running: false;
    in-out property <string> http-port: "8080";
    in-out property <string> https-port: "8443";

    // 规则管理
    in property <[ProxyRule]> rules;
    callback add-rule(string, string, string);
    callback remove-rule(string);

    // 证书管理
    in property <[CertInfo]> certificates;
    callback generate-ca();
    callback open-cert-dir();
    callback delete-cert(string);
    callback export-cert(string);

    // 日志管理
    in property <[LogEntry]> logs;
    callback clear-logs();

    Rectangle {
        width: 100%;
        height: 100%;
        background: root.bg-color;
        // macOS 使用系统窗口圆角，其他平台在未最大化时使用自定义圆角
        border-radius: (root.is-macos || root.is-maximized) ? 0px : 16px;
        clip: true;

        main-focus-scope := FocusScope {
            width: 100%;
            height: 100%;

            // Background TouchArea to clear focus
            TouchArea {
                width: 100%;
                height: 100%;
                clicked => {
                    main-focus-scope.focus();
                }
            }

            VerticalBox {
                padding: 0px;
                spacing: 0px;
                width: 100%;

                // Custom TitleBar
                TitleBar {
                    title: root.title;
                    is-maximized <=> root.is-maximized;
                    is-macos: root.is-macos;
                    titlebar-bg: root.titlebar-bg;
                    text-color: root.text-color;
                    icon-color: root.icon-color;
                    button-hover-bg: root.button-hover-bg;

                    minimize-clicked => {
                        root.minimize-window();
                    }
                    maximize-clicked => {
                        root.is-maximized = root.maximize-window();
                    }
                    close-clicked => {
                        root.close-window();
                    }
                    start-drag => {
                        root.start-drag-window();
                    }
                }

                // Main Content Area
                HorizontalLayout {
                    // Sidebar
                    Sidebar {
                        active-index: 0;
                        dark-mode <=> root.dark-mode;
                        navigate(index) => {
                            self.active-index = index;
                        }
                        toggle-dark-mode => {
                            root.toggle-theme();
                        }
                    }

                    // Right Side Content
                    Rectangle {
                        background: white; // Main content background
                        
                        // Currently only showing Proxy Manager for demo
                        // In a real app, we would switch based on active-index
                        ProxyManager {
                            proxy-running: root.proxy-running;
                            http-port <=> root.http-port;
                            https-port <=> root.https-port;
                            rules: root.rules;
                            certificates: root.certificates;
                            logs: root.logs;
                            toggle-proxy(enable) => {
                                root.toggle-proxy(enable);
                            }
                            add-rule(d, t, p) => {
                                root.add-rule(d, t, p);
                            }
                            remove-rule(id) => {
                                root.remove-rule(id);
                            }
                            generate-ca => {
                                root.generate-ca();
                            }
                            open-cert-dir => {
                                root.open-cert-dir();
                            }
                            delete-cert(id) => {
                                root.delete-cert(id);
                            }
                            export-cert(id) => {
                                root.export-cert(id);
                            }
                            clear-logs => {
                                root.clear-logs();
                            }
                        }
                    }
                }
            }
        }

        // 窗口边缘调整大小区域（仅在非最大化且非 macOS 时启用）
        if !root.is-maximized && !root.is-macos: Rectangle {
            width: 100%;
            height: 100%;

            // 左边缘 (West = 7)
            TouchArea {
                x: 0;
                y: root.resize-border-size;
                width: root.resize-border-size;
                height: parent.height - root.resize-border-size * 2;
                mouse-cursor: ew-resize;
                pointer-event(event) => {
                    if (event.kind == PointerEventKind.down && event.button == PointerEventButton.left) {
                        root.start-resize-window(7);
                    }
                }
            }

            // 右边缘 (East = 0)
            TouchArea {
                x: parent.width - root.resize-border-size;
                y: root.resize-border-size;
                width: root.resize-border-size;
                height: parent.height - root.resize-border-size * 2;
                mouse-cursor: ew-resize;
                pointer-event(event) => {
                    if (event.kind == PointerEventKind.down && event.button == PointerEventButton.left) {
                        root.start-resize-window(0);
                    }
                }
            }

            // 上边缘 (North = 1)
            TouchArea {
                x: root.resize-border-size;
                y: 0;
                width: parent.width - root.resize-border-size * 2;
                height: root.resize-border-size;
                mouse-cursor: ns-resize;
                pointer-event(event) => {
                    if (event.kind == PointerEventKind.down && event.button == PointerEventButton.left) {
                        root.start-resize-window(1);
                    }
                }
            }

            // 下边缘 (South = 4)
            TouchArea {
                x: root.resize-border-size;
                y: parent.height - root.resize-border-size;
                width: parent.width - root.resize-border-size * 2;
                height: root.resize-border-size;
                mouse-cursor: ns-resize;
                pointer-event(event) => {
                    if (event.kind == PointerEventKind.down && event.button == PointerEventButton.left) {
                        root.start-resize-window(4);
                    }
                }
            }

            // 左上角 (NorthWest = 3)
            TouchArea {
                x: 0;
                y: 0;
                width: root.resize-border-size;
                height: root.resize-border-size;
                mouse-cursor: nwse-resize;
                pointer-event(event) => {
                    if (event.kind == PointerEventKind.down && event.button == PointerEventButton.left) {
                        root.start-resize-window(3);
                    }
                }
            }

            // 右上角 (NorthEast = 2)
            TouchArea {
                x: parent.width - root.resize-border-size;
                y: 0;
                width: root.resize-border-size;
                height: root.resize-border-size;
                mouse-cursor: nesw-resize;
                pointer-event(event) => {
                    if (event.kind == PointerEventKind.down && event.button == PointerEventButton.left) {
                        root.start-resize-window(2);
                    }
                }
            }

            // 左下角 (SouthWest = 6)
            TouchArea {
                x: 0;
                y: parent.height - root.resize-border-size;
                width: root.resize-border-size;
                height: root.resize-border-size;
                mouse-cursor: nesw-resize;
                pointer-event(event) => {
                    if (event.kind == PointerEventKind.down && event.button == PointerEventButton.left) {
                        root.start-resize-window(6);
                    }
                }
            }

            // 右下角 (SouthEast = 5)
            TouchArea {
                x: parent.width - root.resize-border-size;
                y: parent.height - root.resize-border-size;
                width: root.resize-border-size;
                height: root.resize-border-size;
                mouse-cursor: nwse-resize;
                pointer-event(event) => {
                    if (event.kind == PointerEventKind.down && event.button == PointerEventButton.left) {
                        root.start-resize-window(5);
                    }
                }
            }
        }
    }
}
