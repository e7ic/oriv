import { Button, VerticalBox, HorizontalBox } from "std-widgets.slint";
import { Sidebar, TitleBar } from "./components/index.slint";
import { ProxyManager } from "./pages/proxy-manager/page.slint";
import { ProxyRule } from "./pages/proxy-manager/components/rules.slint";
import { CertInfo } from "./pages/proxy-manager/components/certificates.slint";
import { LogEntry } from "./pages/proxy-manager/components/logs.slint";
import { HostEntry } from "./pages/proxy-manager/components/hosts.slint";
import { ApiTester, ApiHistoryItem } from "./pages/api-tester/page.slint";
import "../assets/fonts/SourceHanSansSC-Regular.otf";

export component AppWindow inherits Window {
    icon: @image-url("../assets/app-icon.png");
    title: "";
    preferred-width: 1200px;
    preferred-height: 800px;
    min-width: 800px;
    min-height: 600px;
    no-frame: !is-macos;  // macOS 使用原生标题栏，其他平台使用自定义无边框
    background: transparent;
    default-font-family: "Source Han Sans SC";

    in-out property <int> counter: 42;
    callback request-increase-value();

    // 窗口控制回调
    callback minimize-window();
    callback maximize-window() -> bool;  // 返回是否最大化
    callback toggle-fullscreen();
    callback close-window();
    callback start-drag-window();  // 开始拖动窗口
    callback start-resize-window(int);  // 开始调整窗口大小，参数：方向(0-7)

    // 窗口状态
    in-out property <bool> is-maximized: false;

    // 平台检测
    in-out property <bool> is-macos: false;  // 由 Rust 代码设置

    // 主题相关
    in-out property <bool> dark-mode: false;
    callback toggle-theme();

    // 错误处理
    in-out property <string> error-message: "";
    in-out property <bool> show-error-overlay: false;
    in-out property <bool> is-permission-error: false;
    callback show-error(string);
    callback close-error();
    callback retry-as-admin();

    // 颜色定义
    // Slint 1.15: OKLCH color functions
    property <color> bg-color: dark-mode ? Colors.oklch(0.25, 0.03, 258) : Colors.oklch(0.97, 0.01, 255);
    property <color> titlebar-bg: dark-mode ? Colors.oklch(0.18, 0.02, 258) : Colors.oklch(1, 0, 0);
    property <color> text-color: dark-mode ? Colors.oklch(0.96, 0.01, 255) : Colors.oklch(0.22, 0.02, 258);
    property <color> icon-color: dark-mode ? Colors.oklch(0.72, 0.02, 258) : Colors.oklch(0.45, 0.03, 258);
    property <color> button-hover-bg: dark-mode ? Colors.oklch(0.35, 0.03, 258) : Colors.oklch(0.92, 0.01, 255);

    // 窗口调整大小相关
    property <length> resize-border-size: 8px;  // 可拖动边缘的宽度

    // 代理控制
    callback toggle-proxy(bool);
    in property <bool> proxy-running: false;
    in-out property <string> http-port: "80";
    in-out property <string> https-port: "443";

    // 规则管理
    in property <[ProxyRule]> rules;
    callback add-rule(string, string, string);
    callback update-rule(string, string, string, string);
    callback remove-rule(string);
    callback validate-target-port(string) -> bool;

    // 证书管理
    in property <[CertInfo]> certificates;
    callback generate-ca();
    callback open-cert-dir();
    callback delete-cert(string);
    callback export-cert(string);

    // 日志管理
    in property <[LogEntry]> logs;
    callback clear-logs();

    // Hosts
    in property <[HostEntry]> hosts;
    callback refresh-hosts();

    // 页面切换
    in-out property <int> active-tab: 0;

    // API 测试器
    in-out property <string> api-response-body;
    in-out property <string> api-response-headers;
    in-out property <int> api-response-status;
    in-out property <bool> api-is-loading: false;
    in property <[ApiHistoryItem]> api-history;
    callback api-send-request(string, string, string, string);
    callback api-clear-history();
    callback api-select-history(int);

    Rectangle {
        width: 100%;
        height: 100%;
        background: root.bg-color;
        // macOS 使用系统窗口圆角，其他平台在未最大化时使用自定义圆角
        border-radius: (root.is-macos || root.is-maximized) ? 0px : 16px;
        clip: true;

        main-focus-scope := FocusScope {
            width: 100%;
            height: 100%;

            key-pressed(event) => {
                if (root.is-macos && event.text == "f" && event.modifiers.control && event.modifiers.meta) {
                    root.toggle-fullscreen();
                    accept
                } else {
                    reject
                }
            }

            // Background TouchArea to clear focus
            TouchArea {
                width: 100%;
                height: 100%;
                clicked => {
                    main-focus-scope.focus();
                }
            }

            VerticalBox {
                padding: 0px;
                spacing: 0px;
                width: 100%;

                // Custom TitleBar
                if !root.is-macos : TitleBar {
                    title: root.title;
                    is-maximized <=> root.is-maximized;
                    is-macos: root.is-macos;
                    titlebar-bg: root.titlebar-bg;
                    text-color: root.text-color;
                    icon-color: root.icon-color;
                    button-hover-bg: root.button-hover-bg;

                    minimize-clicked => {
                        root.minimize-window();
                    }
                    maximize-clicked => {
                        root.is-maximized = root.maximize-window();
                    }
                    close-clicked => {
                        root.close-window();
                    }
                    start-drag => {
                        root.start-drag-window();
                    }
                }

                // Main Content Area
                HorizontalLayout {
                    // Sidebar
                    Sidebar {
                        active-index <=> root.active-tab;
                        dark-mode <=> root.dark-mode;
                        navigate(index) => {
                            root.active-tab = index;
                        }
                        toggle-dark-mode => {
                            root.toggle-theme();
                        }
                    }

                    // Right Side Content
                    Rectangle {
                        background: white;

                        if root.active-tab == 0: ProxyManager {
                            proxy-running: root.proxy-running;
                            http-port <=> root.http-port;
                            https-port <=> root.https-port;
                            rules: root.rules;
                            certificates: root.certificates;
                            logs: root.logs;
                            hosts: root.hosts;
                            toggle-proxy(enable) => {
                                root.toggle-proxy(enable);
                            }
                            add-rule(d, t, p) => {
                                root.add-rule(d, t, p);
                            }
                            update-rule(id, d, t, p) => {
                                root.update-rule(id, d, t, p);
                            }
                            remove-rule(id) => {
                                root.remove-rule(id);
                            }
                            validate-target-port(target) => {
                                return root.validate-target-port(target);
                            }
                            generate-ca => {
                                root.generate-ca();
                            }
                            open-cert-dir => {
                                root.open-cert-dir();
                            }
                            delete-cert(id) => {
                                root.delete-cert(id);
                            }
                            export-cert(id) => {
                                root.export-cert(id);
                            }
                            clear-logs => {
                                root.clear-logs();
                            }
                            refresh-hosts => {
                                root.refresh-hosts();
                            }
                        }

                        if root.active-tab == 1: ApiTester {
                            response-body: root.api-response-body;
                            response-headers: root.api-response-headers;
                            response-status: root.api-response-status;
                            is-loading: root.api-is-loading;
                            history: root.api-history;
                            send-request(method, url, headers, body) => {
                                root.api-send-request(method, url, headers, body);
                            }
                            clear-history => {
                                root.api-clear-history();
                            }
                            select-history(index) => {
                                root.api-select-history(index);
                            }
                        }
                    }
                }
            }
        }

        // 窗口边缘调整大小区域（仅在非最大化且非 macOS 时启用）
        if !root.is-maximized && !root.is-macos: Rectangle {
            width: 100%;
            height: 100%;

            // 左边缘 (West = 7)
            TouchArea {
                x: 0;
                y: root.resize-border-size;
                width: root.resize-border-size;
                height: parent.height - root.resize-border-size * 2;
                mouse-cursor: ew-resize;
                pointer-event(event) => {
                    if (event.kind == PointerEventKind.down && event.button == PointerEventButton.left) {
                        root.start-resize-window(7);
                    }
                }
            }

            // 右边缘 (East = 0)
            TouchArea {
                x: parent.width - root.resize-border-size;
                y: root.resize-border-size;
                width: root.resize-border-size;
                height: parent.height - root.resize-border-size * 2;
                mouse-cursor: ew-resize;
                pointer-event(event) => {
                    if (event.kind == PointerEventKind.down && event.button == PointerEventButton.left) {
                        root.start-resize-window(0);
                    }
                }
            }

            // 上边缘 (North = 1)
            TouchArea {
                x: root.resize-border-size;
                y: 0;
                width: parent.width - root.resize-border-size * 2;
                height: root.resize-border-size;
                mouse-cursor: ns-resize;
                pointer-event(event) => {
                    if (event.kind == PointerEventKind.down && event.button == PointerEventButton.left) {
                        root.start-resize-window(1);
                    }
                }
            }

            // 下边缘 (South = 4)
            TouchArea {
                x: root.resize-border-size;
                y: parent.height - root.resize-border-size;
                width: parent.width - root.resize-border-size * 2;
                height: root.resize-border-size;
                mouse-cursor: ns-resize;
                pointer-event(event) => {
                    if (event.kind == PointerEventKind.down && event.button == PointerEventButton.left) {
                        root.start-resize-window(4);
                    }
                }
            }

            // 左上角 (NorthWest = 3)
            TouchArea {
                x: 0;
                y: 0;
                width: root.resize-border-size;
                height: root.resize-border-size;
                mouse-cursor: nwse-resize;
                pointer-event(event) => {
                    if (event.kind == PointerEventKind.down && event.button == PointerEventButton.left) {
                        root.start-resize-window(3);
                    }
                }
            }

            // 右上角 (NorthEast = 2)
            TouchArea {
                x: parent.width - root.resize-border-size;
                y: 0;
                width: root.resize-border-size;
                height: root.resize-border-size;
                mouse-cursor: nesw-resize;
                pointer-event(event) => {
                    if (event.kind == PointerEventKind.down && event.button == PointerEventButton.left) {
                        root.start-resize-window(2);
                    }
                }
            }

            // 左下角 (SouthWest = 6)
            TouchArea {
                x: 0;
                y: parent.height - root.resize-border-size;
                width: root.resize-border-size;
                height: root.resize-border-size;
                mouse-cursor: nesw-resize;
                pointer-event(event) => {
                    if (event.kind == PointerEventKind.down && event.button == PointerEventButton.left) {
                        root.start-resize-window(6);
                    }
                }
            }

            // 右下角 (SouthEast = 5)
            TouchArea {
                x: parent.width - root.resize-border-size;
                y: parent.height - root.resize-border-size;
                width: root.resize-border-size;
                height: root.resize-border-size;
                mouse-cursor: nwse-resize;
                pointer-event(event) => {
                    if (event.kind == PointerEventKind.down && event.button == PointerEventButton.left) {
                        root.start-resize-window(5);
                    }
                }
            }

            // Error Overlay
            if root.show-error-overlay : Rectangle {
                background: #00000080;
                TouchArea {
                    clicked => {
                        root.close-error();
                    }
                }
                
                Rectangle {
                    width: 400px;
                    height: 200px;
                    background: white;
                    border-radius: 12px;
                    
                    VerticalBox {
                        padding: 24px;
                        spacing: 16px;
                        alignment: center;
                        
                        Text {
                            text: "错误";
                            font-size: 18px;
                            font-weight: 600;
                            color: #ef4444;
                            horizontal-alignment: center;
                        }
                        
                        Text {
                            text: root.error-message;
                            font-size: 14px;
                            color: #374151;
                            wrap: word-wrap;
                            horizontal-alignment: center;
                            vertical-stretch: 1;
                        }
                        
                        HorizontalLayout {
                            alignment: center;
                            spacing: 16px;
                            
                            if root.is-permission-error : Button {
                                text: "以管理员身份重启";
                                height: 36px;
                                clicked => {
                                    root.retry-as-admin();
                                }
                            }
                            
                            Button {
                                text: "关闭";
                                primary: !root.is-permission-error;
                                height: 36px;
                                clicked => {
                                    root.close-error();
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}
